#!/usr/bin/env bash

source ./install_pkg.sh

DB_FILE="tstall.db"

create_db() {
    if [ ! -f "$DB_FILE" ]; then
        sqlite3 "$DB_FILE" "VACUUM;"
    fi

    sqlite3 "$DB_FILE" <<EOF
CREATE TABLE IF NOT EXISTS installed_packages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    manager TEXT NOT NULL,
    version TEXT,
    label TEXT,
    installed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
EOF
}

add_dummy_data() {
    sqlite3 "$DB_FILE" <<EOF
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('jump', 'apt', '2.0.0', 'opensource');
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('walk', 'snap', '2.0.1', 'tech');
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('dance', 'apt', '2.5.0', 'python');
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('yelo', 'apt-get', '2.4.0', 'test');
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('can', 'apt', '2.1.0', 'dev');
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('dust', 'snap', '3.0.0', 'dev');
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('make', 'snap', '1.8.9', 'dev');
INSERT INTO installed_packages (name, manager, version, label)
VALUES ('done', 'apt-get', '2.0.0', 'php');
EOF
}

list_installed_packages() {

    if [[ ! -f "$DB_FILE" ]]; then
        echo "Database file '$DB_FILE' does not exist."
        return 1
    fi

    {
    
    echo -e "\033[1;33mControls:\033[0m"
    echo -e "\e[7m↑ / ↓ : Scroll up/down | ← / → : Scroll left/right | Space : Next page | q : Quit view\e[0m"
    # echo "  ← / → : Scroll left/right"
    # echo "  Space : Next page"
    # echo "  q     : Quit view"
    echo

    # echo "Installed Packages:"
    sqlite3 "$DB_FILE" <<EOF
.headers on
.mode column
.width 15 30 15 15 40
SELECT * FROM installed_packages;
EOF
} | LESS='-SR' less
}

help () {
    local PROGRAM_NAME="tstall"
    cat << EOF
$PROGRAM_NAME - [Short description of your tool]

Usage: $PROGRAM_NAME [options] <command>

Basic commands:
  install           install packages.
  remove            remove packages.
  list              list all installed packages.
  list-labels       list all labels.
  search            search installed package.
  search-labels     search labels.
  edit              Edit an installed package data.
  edit-label        Edit a label.


Options:
  -h, --help, help  Show this help message.
  -v, --version     Show version info.

Examples:
  $PROGRAM_NAME install [package...]
  $PROGRAM_NAME list

For more information about a command, run '$PROGRAM_NAME help <command>'.
EOF
}

install_help () {
    cat << EOF
Usage: 
  $PROGRAM_NAME install <package>...
  $PROGRAM_NAME install <package manager> <package>...
EOF
}

main() {
    case "$1" in
        install)
            shift
            install_package "$@"
            ;;
        remove)
            shift
            echo "Remove $@"
            ;;
        list)
            list_installed_packages
            ;;
        list-labels)
            echo "List labels"
            ;;
        -v|--version)
            shift
            local version=$(get_version "$@")
            echo "$version"
            ;;
        search-label)
            case "$2" in
                label)
                    echo "Search label here"
                    ;;
                package)
                    echo "Search package here!!!"
                    ;;
                *)
                    echo "Unknown"
            esac
            # shift
            # echo "Searching: $@"
            ;;
        help|*)
            help
            ;;
    esac
}

create_db
# add_dummy_data
main "$@"
# list_installed_packages